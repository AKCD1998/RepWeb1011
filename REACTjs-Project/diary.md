## 2026-02-24 15:06:16 +07:00 - Deliver table: remove unit/sum columns
- Files changed: `src/pages/Deliver.jsx`, `src/pages/Deliver.css`.
- Removed from table UI:
  - Header `ราคาต่อหน่วย` (`hide-sm`) and row cell `item-price`.
  - Header `ราคารวม` (`sum`) and row cell `item-sum`.
- Kept POS logic unchanged: barcode lookup/add, qty behavior, delete action, and bottom grand total display.

How to verify:
- [ ] Add 2 items (scan/Enter), then add the same item again and confirm qty increments.
- [ ] Delete 1 item from `NOTE` column and confirm bottom grand total (`รวม`) updates.
- [ ] Open modal via `ยืนยันการทำรายการ`, close via cancel/close button, `Escape`, and backdrop click.
- [ ] Check narrow widths (<=768 and <=480) to ensure `hide-md` layout remains aligned with no awkward grid gaps.

## 2026-02-24 17:06:24 +07:00 - KY10/11 PostgreSQL schema design
- Summary:
  - Designed multi-branch PostgreSQL schema for ขย 10/11 dispensing + inventory tracking.
  - Added structured product composition (multi-ingredient), structured strength units, packaging hierarchy, stock ledger/snapshot, dispensing visit/line tables, user/patient/location masters, and configurable dispensing rules.
  - Added seed data for branches `001`, `003`, `004` plus minimal dosage forms and unit types.
  - Added ready-to-use example SQL queries for stock, movement audit, patient history, and rule-violation detection.
- Files added:
  - `SCHEMA_KY1011.md`
  - `migrations/0001_ky1011_schema.sql`
  - `migrations/0002_ky1011_seed_reference.sql`
  - `migrations/0003_ky1011_example_queries.sql`
- Next steps:
  - Run migrations in a PostgreSQL environment and validate with sample products/lots.
  - Implement application service/trigger to keep `stock_on_hand` synchronized from `stock_movements`.
  - Add conversion-aware rule check (BOX -> BLISTER, etc.) in service/query layer for stricter enforcement.

## 2026-02-24 17:14:00 +07:00 - Add regulatory report grouping (KY10/KY11)
- Summary:
  - Added extensible regulatory grouping model with effective dating (`report_groups`, `product_report_groups`).
  - Seeded report groups: `KY10` and `KY11`.
  - Added query examples for current KY10/KY11 membership, overlap, KY11 dispensing history, and missing classification detection.
  - Updated schema document with architecture rationale and textual ER diagram for regulatory mapping.
- Files changed:
  - `migrations/0004_ky1011_report_groups.sql`
  - `migrations/0003_ky1011_example_queries.sql`
  - `SCHEMA_KY1011.md`
  - `diary.md`
- Next steps:
  - Implement KY10/KY11 report-generation SQL view(s) using `dispense_headers`, `dispense_lines`, and time-valid `product_report_groups`.
  - Add automated validation tests for effective date windows and duplicate/overlap policy.

## 2026-02-24 17:50:50 +07:00 - Backend env/API MVP with PostgreSQL
- Summary:
  - Implemented server-first environment loading (`server/.env`, fallback to root `.env`) and added env examples.
  - Added PostgreSQL access layer with `pg` pool and health check, plus modular Express structure (`routes` + `controllers`).
  - Implemented transactional endpoints for product CRUD, inventory receive/transfer, dispensing, stock on hand, movements, and patient dispense history.
  - Implemented stock snapshot updates (`stock_on_hand`) in the same DB transaction as movement inserts.
  - Added frontend API wrapper and a working Products CRUD screen connected to backend HTTP APIs.
  - Updated Vite proxy to backend port `5050`, and kept `/api/patients` compatibility endpoint (DB first, CSV fallback).
- Files added/changed:
  - `server/.env.example`
  - `.env.example`
  - `.gitignore`
  - `server/index.js`
  - `server/db/pool.js`
  - `server/controllers/helpers.js`
  - `server/controllers/productsController.js`
  - `server/controllers/inventoryController.js`
  - `server/controllers/dispenseController.js`
  - `server/routes/productsRoutes.js`
  - `server/routes/inventoryRoutes.js`
  - `server/routes/dispenseRoutes.js`
  - `server/routes/reportingRoutes.js`
  - `server/utils/asyncHandler.js`
  - `server/utils/httpError.js`
  - `migrations/0002_ky1011_seed_reference.sql` (seed `system` user)
  - `src/lib/api.js`
  - `src/pages/Products.jsx`
  - `src/pages/Products.css`
  - `src/App.jsx`
  - `src/components/Sidebar.jsx`
  - `src/utils/deliverApiBase.js`
  - `vite.config.js`
  - `README.md`
  - `diary.md`
- Next steps:
  - Add migration runner script (or npm script) to execute SQL files in order automatically.
  - Build dedicated Receive/Transfer/Deliver submit forms on top of new `src/lib/api.js` methods.
  - Add authentication middleware (JWT) and role-based authorization for write endpoints.

## 2026-02-25 09:13:08 +07:00 - Auth fields migration for users table
- Summary:
  - Added `migrations/0005_auth_fields.sql` to prepare username/password login data shape in PostgreSQL.
  - Ensured `users` has/keeps required auth columns and defaults: `username`, `password_hash`, `role`, `location_id`, `is_active`, `created_at`, `updated_at`.
  - Added explicit unique index `idx_users_username_unique` for username lookups.
  - Added rule constraint `ck_users_branch_user_requires_location`: `ADMIN` can be `location_id = NULL`, while branch roles (`PHARMACIST`/`OPERATOR`) must have a location.
  - Seeded users with bcrypt(cost 10) hash for password `changeme`: `admin000`, `branch001`, `branch003`, `branch004`.
- Files added/changed:
  - `migrations/0005_auth_fields.sql`
  - `diary.md`
- Notes:
  - `location_id` is nullable for ADMIN because central admin accounts may operate across all branches (global scope), while branch users must be pinned to a specific branch for auditability and access control boundaries.

## 2026-02-25 09:19:20 +07:00 - JWT login endpoint and auth middleware
- Summary:
  - Added authentication module for login with username/password and JWT.
  - Implemented `POST /api/auth/login` in `authController`:
    - validates input (`username`, `password`)
    - checks user existence + `is_active`
    - verifies password with bcrypt compare
    - returns JWT token (8h expiry) + normalized user payload (`id`, `username`, `role`, `location_id`)
  - Added reusable `verifyToken` middleware to parse Bearer token, verify JWT, and attach `req.user`.
  - Registered auth routes under `/api/auth` in server bootstrap.
  - Updated `server/.env.example` to include `JWT_SECRET`.
- Files added/changed:
  - `server/controllers/authController.js`
  - `server/routes/authRoutes.js`
  - `server/middleware/authMiddleware.js`
  - `server/index.js`
  - `server/.env.example`
  - `diary.md`

## 2026-02-25 09:31:02 +07:00 - Role-based authorization + branch protection
- Summary:
  - Extended auth middleware with reusable RBAC/branch guards:
    - `requireRole(...roles)`
    - `requireBranchAccess(...)`
  - Enforced role rules:
    - `ADMIN` bypasses branch restrictions
    - `PHARMACIST` must operate only on their own branch context
    - `OPERATOR` is blocked for non-read methods (read-only behavior)
  - Added branch protection that resolves branch from `req.user.location_id` and checks mismatch as `403`.
  - Added branch field forcing for pharmacist routes so server-side branch is authoritative (never trusting client branch field blindly).
  - Protected write routes:
    - inventory: `/receive`, `/transfer`
    - dispense: `POST /api/dispense`
    - products write: `POST/PUT/DELETE /api/products`
  - Updated controllers to prefer authenticated actor ID (`req.user.id`) over client-sent user IDs for create/movement attribution.
- Files added/changed:
  - `server/middleware/authMiddleware.js`
  - `server/routes/inventoryRoutes.js`
  - `server/routes/dispenseRoutes.js`
  - `server/routes/productsRoutes.js`
  - `server/controllers/inventoryController.js`
  - `server/controllers/dispenseController.js`
  - `diary.md`
- Verification:
  - `POST /api/products` without token -> `401`
  - `POST /api/products` with `PHARMACIST` token -> `403`
  - `POST /api/products` with `ADMIN` token -> `201`
  - `POST /api/inventory/receive` with pharmacist + mismatched branch -> `403`
  - `POST /api/dispense` with pharmacist + mismatched branch -> `403`

## 2026-02-25 09:41:03 +07:00 - Frontend login/auth state + protected routes
- Summary:
  - Added client-side auth state via `AuthContext` with login/logout and localStorage persistence.
  - Added `Login` page (`/login`) with username/password form and submit flow to backend `POST /api/auth/login`.
  - Added Axios API client with interceptors:
    - request: attach `Authorization: Bearer <token>` from localStorage
    - response: on `401` clear auth storage and trigger auto-logout event
  - Protected app routes in `App.jsx`:
    - unauthenticated users are redirected to `/login`
    - authenticated users visiting `/login` are redirected to `/`
  - Refactored existing `src/lib/api.js` to use the shared Axios client so token is applied consistently to API calls.
- Files added/changed:
  - `src/context/AuthContext.jsx`
  - `src/pages/Login.jsx`
  - `src/pages/Login.css`
  - `src/lib/authApi.js`
  - `src/lib/api.js`
  - `src/App.jsx`
  - `src/main.jsx`
  - `diary.md`
- Next steps:
  - Add logout action in UI (e.g. header/sidebar button) to clear session manually.
  - Add role-aware route visibility (hide/disable pages by role).

## 2026-02-25 10:17:09 +07:00 - JWT revocation blacklist + safe logout
- Summary:
  - Added token revocation data model for logout invalidation before JWT expiry.
  - Added migration `0006_auth_revoked_tokens.sql` with `revoked_tokens` table, unique `jti`, FK to `users`, and lookup indexes.
  - Updated login to issue JWT with unique `jti` claim (`jwtid`) while keeping normal `iat`/`exp`.
  - Added `POST /api/auth/logout` (auth required) to blacklist current token `jti` with `expires_at` and reason `LOGOUT`.
  - Updated `verifyToken` middleware to reject revoked tokens (`401 Token revoked`) by checking `revoked_tokens`.
  - Updated frontend auth flow:
    - `AuthContext.logout()` now calls backend logout endpoint first.
    - logout always clears local auth state/storage even if API call fails.
    - logout redirects to `/login`.
    - interceptor ignores `/api/auth/logout` 401 loop and still auto-logs-out on other `401`s.
- Files added/changed:
  - `migrations/0006_auth_revoked_tokens.sql`
  - `server/controllers/authController.js`
  - `server/routes/authRoutes.js`
  - `server/middleware/authMiddleware.js`
  - `src/lib/authApi.js`
  - `src/context/AuthContext.jsx`
  - `diary.md`
- How to verify:
  - Login -> call protected write endpoint with token -> non-401 response (e.g. expected validation error).
  - Logout -> retry same endpoint with old token -> `401 Token revoked`.
  - Login again -> new token works.

## 2026-02-25 10:46:47 +07:00 - Sidebar logout button with fallback flow
- Summary:
  - Added a visible `ออกจากระบบ` button at the bottom of Sidebar.
  - Wired button to AuthContext logout (preferred path) using optional auth context access.
  - Added safe fallback logout when context is missing/fails:
    - reads token from localStorage
    - `POST http://localhost:5050/api/auth/logout` with Bearer token
    - always clears `rx1011_auth_token` and `rx1011_auth_user`
    - redirects to `/login`
    - no uncaught errors on API/network failure
  - Added sidebar footer/button styles and collapsed-mode alignment so logout stays anchored and readable on narrow widths.
- Files changed:
  - `src/components/Sidebar.jsx`
  - `src/AppLayout.css`
  - `src/context/AuthContext.jsx` (added `useOptionalAuth`)
  - `diary.md`
- Verification checklist:
  - [ ] Login and confirm Sidebar shows `ออกจากระบบ` at bottom.
  - [ ] Click logout and confirm redirect to `/login`.
  - [ ] Try to open protected route after logout and confirm redirect/login guard.
  - [ ] Confirm localStorage keys `rx1011_auth_token` and `rx1011_auth_user` are removed.
  - [ ] Stop backend temporarily, click logout, and confirm UI still clears local session + redirects.

## 2026-02-25 11:44:14 +07:00 - Receiving cleanup: remove Add New tile + table placeholders
- Summary:
  - Removed the `เพิ่มสินค้าใหม่` tile/button (`addTile`) from Receiving page top section.
  - Kept layout blocks: action tile (`ลงข้อมูลรับเข้า ส่งออกสินค้า`), search panel, config bar, results card/table shell.
  - Refactored table shell to React-rendered placeholders:
    - added minimal state scaffold `movements`
    - rendered header columns from array
    - rendered placeholder row when no data exists
  - Cleaned related CSS:
    - updated top grid to 2 columns after removing tile
    - removed now-unused `addTile` style rules
    - added subtle placeholder-row style
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `diary.md`
- Visual verification checklist:
  - [ ] Receiving page no longer shows `เพิ่มสินค้าใหม่` tile.
  - [ ] Action tile + search panel remain aligned on desktop and stack correctly on small screens.
  - [ ] Config bar and results card still render below top section.
  - [ ] Table area shows header labels and placeholder row text when empty.

## 2026-02-25 11:48:28 +07:00 - Receiving movement entry modal (UI-only)
- Summary:
  - Added movement entry modal on Receiving page, opened by clicking action tile `ลงข้อมูลรับเข้า ส่งออกสินค้า`.
  - Added UI-only form fields:
    - movement type (`RECEIVE`, `TRANSFER_OUT`, `DISPENSE`) with Thai labels
    - conditional location text field (source/destination; hidden for `DISPENSE`)
    - product search input + `ค้นหา` button (mock selection only)
    - product selected placeholder text
    - quantity, unit, occurred date-time
  - Added required-field validation messages and form submission behavior:
    - validates required inputs
    - appends one mock row to `movements` state
    - closes modal on save
  - Added modal UX:
    - close by `Escape`
    - close by backdrop click
  - Added styles for modal form layout, field errors, and responsive behavior.
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `diary.md`
- Verification checklist:
  - [ ] Click action tile and confirm movement modal opens.
  - [ ] Press `Escape` and backdrop click to confirm modal closes.
  - [ ] Try save with empty required fields and confirm error messages appear.
  - [ ] Fill required fields and save; confirm a new mock row appears in the table.
  - [ ] Confirm layout is readable on narrow screens.

## 2026-02-25 11:55:05 +07:00 - Receiving movement table rendering + delta color accents
- Summary:
  - Implemented real table rendering from `movements` state using 5 columns:
    - เวลา
    - สินค้า
    - รหัสสินค้า
    - ประเภท
    - การเปลี่ยนแปลงสต๊อก
  - Updated movement row model (mock save) to store:
    - `movementType` as raw code (`RECEIVE`/`TRANSFER_OUT`/`DISPENSE`)
    - `qtyValue`, `unit`, and placeholder `productCode`
  - Added movement type badge display and delta rules:
    - `RECEIVE` -> `+<qty> <unit>` with readable dark-mode green accent
    - `TRANSFER_OUT` / `DISPENSE` -> `-<qty> <unit>` with readable dark-mode red accent
  - Kept row background unchanged; only badge/text accent colors were added.
  - `tableTotals` count remains bound to movement row count (`รวม N รายการ`).
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `diary.md`
- Verification checklist:
  - [ ] Add row via movement modal with type `รับเข้า` and confirm delta shows `+` in green.
  - [ ] Add row via `โอนออก` or `ส่งมอบลูกค้า` and confirm delta shows `-` in red.
  - [ ] Confirm movement type badges render per row.
  - [ ] Confirm total counter updates to number of rows shown.

## 2026-02-25 12:03:27 +07:00 - Receiving connected to backend movement APIs
- Summary:
  - Connected Receiving modal save flow to backend inventory endpoints and replaced mock-only table rows with server data.
  - Endpoints used:
    - `POST /api/inventory/receive`
    - `POST /api/inventory/transfer`
    - `GET /api/movements`
  - Added frontend API helpers in `src/lib/api.js`:
    - `inventoryApi.createMovement(payload)` (maps modal type to receive/transfer endpoints)
    - `inventoryApi.listMovements({ location_id, limit, fromDate, toDate })`
  - Updated Receiving page data flow:
    - On mount: fetch recent movements for logged-in user location (`user.location_id`) via `listMovements`.
    - On modal save: validate -> `createMovement` -> refresh list from DB.
    - Product selection now uses backend product search (`GET /api/products?search=`) to get `productId` before save.
  - Backend update for movement listing security/scope:
    - `/api/movements` now requires auth (`verifyToken` + role check).
    - `getMovements` accepts `location_id` and enforces non-admin users to their own `req.user.location_id` (rejects mismatch with `403`).
  - Branch override safety:
    - UI does not expose/submit origin branch override.
    - Branch scope derives from authenticated user (`location_id`) and backend auth middleware/rules.
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `src/lib/api.js`
  - `server/routes/reportingRoutes.js`
  - `server/controllers/inventoryController.js`
  - `diary.md`
- Verification checklist:
  - [ ] Login as branch user and open Receiving page; table should load recent branch movements.
  - [ ] Create `RECEIVE` movement from modal and confirm new row appears after save.
  - [ ] Create `TRANSFER_OUT` movement (destination branch code) and confirm row appears after save.
  - [ ] Confirm totals update (`รวม N รายการ`) and delta color rule remains `+` green / `-` red.
  - [ ] Confirm stock changes in backend snapshots (if unit/lot constraints are satisfied and stock update succeeds).

## 2026-02-25 13:06:40 +07:00 - Receiving modal: product search + select from DB
- Summary:
  - Replaced movement modal product placeholder flow with real product search against backend (`GET /api/products?search=`).
  - Added searchable result list (top 20) with clickable selection to set:
    - `productId`
    - `productName`
    - `productCode`
  - Updated save precondition so movement submission requires a selected `productId` from search results.
  - Added UX states inside modal:
    - loading (`กำลังค้นหาสินค้า...`)
    - empty result message
    - API error message
    - selected product highlight in result list
  - Kept flow lightweight (no pagination) and preserved existing movement create + refresh behavior.
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `diary.md`
- Verification checklist:
  - [ ] Open Receiving modal and type keyword (`ชื่อสามัญ/บริษัท/บาร์โค้ด`) then click `ค้นหา`.
  - [ ] Confirm result list appears (max ~20 rows) and each row is clickable.
  - [ ] Click one product and confirm `ยังไม่ได้เลือกสินค้า` changes to selected product text.
  - [ ] Try saving without selecting product and confirm validation error appears.
  - [ ] Save with selected product and confirm movement is created and table refreshes.

## 2026-02-25 15:21:29 +07:00 - Receiving movement modal: admin location selector + branch lock enforcement
- Summary:
  - Fixed modal gate so `ADMIN` users without `location_id` (e.g. `admin000`) can open movement modal.
  - Added role-aware location flow in Receiving modal:
    - `ADMIN`: can choose `จากสถานที่` (`from_location_id`) and `ไปยัง` (`to_location_id`) from location selector.
    - Branch user (`PHARMACIST`): locked to own `location_id` by movement type (`RECEIVE` locks `to`, `TRANSFER_OUT`/`DISPENSE` lock `from`).
  - Added frontend location loading/caching via new API call `GET /api/locations`.
  - Refactored movement submit to use unified endpoint `POST /api/inventory/movements` and send role-appropriate payload.
  - Backend added movement endpoint enforcement:
    - Non-admin branch context enforced from `req.user.location_id`; override attempts on locked fields return `403`.
    - Admin can submit selected locations (validated as active IDs).
    - Validation rules enforced by type: `RECEIVE` requires `to`, `TRANSFER_OUT` requires `from`+`to`, `DISPENSE` requires `from`.
  - Added backend read-only locations endpoint `GET /api/locations` (`ADMIN`/`PHARMACIST`/`OPERATOR`).
- Files changed:
  - `src/pages/Receiving.jsx`
  - `src/pages/Receiving.css`
  - `src/lib/api.js`
  - `server/controllers/inventoryController.js`
  - `server/routes/inventoryRoutes.js`
  - `server/routes/reportingRoutes.js`
  - `diary.md`
- Verification checklist:
  - [ ] Login as `admin000`:
    - click action tile -> modal opens
    - can choose `from/to` location and save (or pass form validation)
  - [ ] Login as `branch001`:
    - modal opens
    - location is locked to branch001 for `RECEIVE` / `TRANSFER_OUT` / `DISPENSE`
  - [ ] Try to tamper payload in devtools as branch user:
    - backend rejects mismatch (`403`) on locked field overrides or enforces user location context
  - [ ] No regressions in other pages.
