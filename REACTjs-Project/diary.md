## 2026-02-24 15:06:16 +07:00 - Deliver table: remove unit/sum columns
- Files changed: `src/pages/Deliver.jsx`, `src/pages/Deliver.css`.
- Removed from table UI:
  - Header `ราคาต่อหน่วย` (`hide-sm`) and row cell `item-price`.
  - Header `ราคารวม` (`sum`) and row cell `item-sum`.
- Kept POS logic unchanged: barcode lookup/add, qty behavior, delete action, and bottom grand total display.

How to verify:
- [ ] Add 2 items (scan/Enter), then add the same item again and confirm qty increments.
- [ ] Delete 1 item from `NOTE` column and confirm bottom grand total (`รวม`) updates.
- [ ] Open modal via `ยืนยันการทำรายการ`, close via cancel/close button, `Escape`, and backdrop click.
- [ ] Check narrow widths (<=768 and <=480) to ensure `hide-md` layout remains aligned with no awkward grid gaps.

## 2026-02-24 17:06:24 +07:00 - KY10/11 PostgreSQL schema design
- Summary:
  - Designed multi-branch PostgreSQL schema for ขย 10/11 dispensing + inventory tracking.
  - Added structured product composition (multi-ingredient), structured strength units, packaging hierarchy, stock ledger/snapshot, dispensing visit/line tables, user/patient/location masters, and configurable dispensing rules.
  - Added seed data for branches `001`, `003`, `004` plus minimal dosage forms and unit types.
  - Added ready-to-use example SQL queries for stock, movement audit, patient history, and rule-violation detection.
- Files added:
  - `SCHEMA_KY1011.md`
  - `migrations/0001_ky1011_schema.sql`
  - `migrations/0002_ky1011_seed_reference.sql`
  - `migrations/0003_ky1011_example_queries.sql`
- Next steps:
  - Run migrations in a PostgreSQL environment and validate with sample products/lots.
  - Implement application service/trigger to keep `stock_on_hand` synchronized from `stock_movements`.
  - Add conversion-aware rule check (BOX -> BLISTER, etc.) in service/query layer for stricter enforcement.

## 2026-02-24 17:14:00 +07:00 - Add regulatory report grouping (KY10/KY11)
- Summary:
  - Added extensible regulatory grouping model with effective dating (`report_groups`, `product_report_groups`).
  - Seeded report groups: `KY10` and `KY11`.
  - Added query examples for current KY10/KY11 membership, overlap, KY11 dispensing history, and missing classification detection.
  - Updated schema document with architecture rationale and textual ER diagram for regulatory mapping.
- Files changed:
  - `migrations/0004_ky1011_report_groups.sql`
  - `migrations/0003_ky1011_example_queries.sql`
  - `SCHEMA_KY1011.md`
  - `diary.md`
- Next steps:
  - Implement KY10/KY11 report-generation SQL view(s) using `dispense_headers`, `dispense_lines`, and time-valid `product_report_groups`.
  - Add automated validation tests for effective date windows and duplicate/overlap policy.

## 2026-02-24 17:50:50 +07:00 - Backend env/API MVP with PostgreSQL
- Summary:
  - Implemented server-first environment loading (`server/.env`, fallback to root `.env`) and added env examples.
  - Added PostgreSQL access layer with `pg` pool and health check, plus modular Express structure (`routes` + `controllers`).
  - Implemented transactional endpoints for product CRUD, inventory receive/transfer, dispensing, stock on hand, movements, and patient dispense history.
  - Implemented stock snapshot updates (`stock_on_hand`) in the same DB transaction as movement inserts.
  - Added frontend API wrapper and a working Products CRUD screen connected to backend HTTP APIs.
  - Updated Vite proxy to backend port `5050`, and kept `/api/patients` compatibility endpoint (DB first, CSV fallback).
- Files added/changed:
  - `server/.env.example`
  - `.env.example`
  - `.gitignore`
  - `server/index.js`
  - `server/db/pool.js`
  - `server/controllers/helpers.js`
  - `server/controllers/productsController.js`
  - `server/controllers/inventoryController.js`
  - `server/controllers/dispenseController.js`
  - `server/routes/productsRoutes.js`
  - `server/routes/inventoryRoutes.js`
  - `server/routes/dispenseRoutes.js`
  - `server/routes/reportingRoutes.js`
  - `server/utils/asyncHandler.js`
  - `server/utils/httpError.js`
  - `migrations/0002_ky1011_seed_reference.sql` (seed `system` user)
  - `src/lib/api.js`
  - `src/pages/Products.jsx`
  - `src/pages/Products.css`
  - `src/App.jsx`
  - `src/components/Sidebar.jsx`
  - `src/utils/deliverApiBase.js`
  - `vite.config.js`
  - `README.md`
  - `diary.md`
- Next steps:
  - Add migration runner script (or npm script) to execute SQL files in order automatically.
  - Build dedicated Receive/Transfer/Deliver submit forms on top of new `src/lib/api.js` methods.
  - Add authentication middleware (JWT) and role-based authorization for write endpoints.

## 2026-02-25 09:13:08 +07:00 - Auth fields migration for users table
- Summary:
  - Added `migrations/0005_auth_fields.sql` to prepare username/password login data shape in PostgreSQL.
  - Ensured `users` has/keeps required auth columns and defaults: `username`, `password_hash`, `role`, `location_id`, `is_active`, `created_at`, `updated_at`.
  - Added explicit unique index `idx_users_username_unique` for username lookups.
  - Added rule constraint `ck_users_branch_user_requires_location`: `ADMIN` can be `location_id = NULL`, while branch roles (`PHARMACIST`/`OPERATOR`) must have a location.
  - Seeded users with bcrypt(cost 10) hash for password `changeme`: `admin000`, `branch001`, `branch003`, `branch004`.
- Files added/changed:
  - `migrations/0005_auth_fields.sql`
  - `diary.md`
- Notes:
  - `location_id` is nullable for ADMIN because central admin accounts may operate across all branches (global scope), while branch users must be pinned to a specific branch for auditability and access control boundaries.

## 2026-02-25 09:19:20 +07:00 - JWT login endpoint and auth middleware
- Summary:
  - Added authentication module for login with username/password and JWT.
  - Implemented `POST /api/auth/login` in `authController`:
    - validates input (`username`, `password`)
    - checks user existence + `is_active`
    - verifies password with bcrypt compare
    - returns JWT token (8h expiry) + normalized user payload (`id`, `username`, `role`, `location_id`)
  - Added reusable `verifyToken` middleware to parse Bearer token, verify JWT, and attach `req.user`.
  - Registered auth routes under `/api/auth` in server bootstrap.
  - Updated `server/.env.example` to include `JWT_SECRET`.
- Files added/changed:
  - `server/controllers/authController.js`
  - `server/routes/authRoutes.js`
  - `server/middleware/authMiddleware.js`
  - `server/index.js`
  - `server/.env.example`
  - `diary.md`

## 2026-02-25 09:31:02 +07:00 - Role-based authorization + branch protection
- Summary:
  - Extended auth middleware with reusable RBAC/branch guards:
    - `requireRole(...roles)`
    - `requireBranchAccess(...)`
  - Enforced role rules:
    - `ADMIN` bypasses branch restrictions
    - `PHARMACIST` must operate only on their own branch context
    - `OPERATOR` is blocked for non-read methods (read-only behavior)
  - Added branch protection that resolves branch from `req.user.location_id` and checks mismatch as `403`.
  - Added branch field forcing for pharmacist routes so server-side branch is authoritative (never trusting client branch field blindly).
  - Protected write routes:
    - inventory: `/receive`, `/transfer`
    - dispense: `POST /api/dispense`
    - products write: `POST/PUT/DELETE /api/products`
  - Updated controllers to prefer authenticated actor ID (`req.user.id`) over client-sent user IDs for create/movement attribution.
- Files added/changed:
  - `server/middleware/authMiddleware.js`
  - `server/routes/inventoryRoutes.js`
  - `server/routes/dispenseRoutes.js`
  - `server/routes/productsRoutes.js`
  - `server/controllers/inventoryController.js`
  - `server/controllers/dispenseController.js`
  - `diary.md`
- Verification:
  - `POST /api/products` without token -> `401`
  - `POST /api/products` with `PHARMACIST` token -> `403`
  - `POST /api/products` with `ADMIN` token -> `201`
  - `POST /api/inventory/receive` with pharmacist + mismatched branch -> `403`
  - `POST /api/dispense` with pharmacist + mismatched branch -> `403`

## 2026-02-25 09:41:03 +07:00 - Frontend login/auth state + protected routes
- Summary:
  - Added client-side auth state via `AuthContext` with login/logout and localStorage persistence.
  - Added `Login` page (`/login`) with username/password form and submit flow to backend `POST /api/auth/login`.
  - Added Axios API client with interceptors:
    - request: attach `Authorization: Bearer <token>` from localStorage
    - response: on `401` clear auth storage and trigger auto-logout event
  - Protected app routes in `App.jsx`:
    - unauthenticated users are redirected to `/login`
    - authenticated users visiting `/login` are redirected to `/`
  - Refactored existing `src/lib/api.js` to use the shared Axios client so token is applied consistently to API calls.
- Files added/changed:
  - `src/context/AuthContext.jsx`
  - `src/pages/Login.jsx`
  - `src/pages/Login.css`
  - `src/lib/authApi.js`
  - `src/lib/api.js`
  - `src/App.jsx`
  - `src/main.jsx`
  - `diary.md`
- Next steps:
  - Add logout action in UI (e.g. header/sidebar button) to clear session manually.
  - Add role-aware route visibility (hide/disable pages by role).

## 2026-02-25 10:17:09 +07:00 - JWT revocation blacklist + safe logout
- Summary:
  - Added token revocation data model for logout invalidation before JWT expiry.
  - Added migration `0006_auth_revoked_tokens.sql` with `revoked_tokens` table, unique `jti`, FK to `users`, and lookup indexes.
  - Updated login to issue JWT with unique `jti` claim (`jwtid`) while keeping normal `iat`/`exp`.
  - Added `POST /api/auth/logout` (auth required) to blacklist current token `jti` with `expires_at` and reason `LOGOUT`.
  - Updated `verifyToken` middleware to reject revoked tokens (`401 Token revoked`) by checking `revoked_tokens`.
  - Updated frontend auth flow:
    - `AuthContext.logout()` now calls backend logout endpoint first.
    - logout always clears local auth state/storage even if API call fails.
    - logout redirects to `/login`.
    - interceptor ignores `/api/auth/logout` 401 loop and still auto-logs-out on other `401`s.
- Files added/changed:
  - `migrations/0006_auth_revoked_tokens.sql`
  - `server/controllers/authController.js`
  - `server/routes/authRoutes.js`
  - `server/middleware/authMiddleware.js`
  - `src/lib/authApi.js`
  - `src/context/AuthContext.jsx`
  - `diary.md`
- How to verify:
  - Login -> call protected write endpoint with token -> non-401 response (e.g. expected validation error).
  - Logout -> retry same endpoint with old token -> `401 Token revoked`.
  - Login again -> new token works.
